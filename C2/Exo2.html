<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Compl√®te les terminaisons √† l‚Äôimp√©ratif ‚Äì ExI</title>
<style>
:root{--base-size:18px;--ok:#2e7d32;--ko:#c62828;--bg:#f7fbff;}
html,body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;font-size:var(--base-size);line-height:1.5;color:#111}
.bar{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 14px;background:#fff;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:5}
.btn{appearance:none;border:1px solid #d1d5db;background:#fff;border-radius:8px;padding:7px 10px;cursor:pointer;font-size:0.9rem}
.btn:hover{background:#f8fafc}
.btn.primary{background:#2563eb;border-color:#2563eb;color:#fff}
.btn.small{font-size:0.8rem;padding:5px 8px;border-radius:6px}
.wrap{max-width:900px;margin:20px auto;padding:0 14px 30px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.04);padding:20px}
h1{font-size:1.2rem;margin:.2rem 0 1rem}
input.blk{min-width:5ch;padding:6px 8px;margin:2px 4px;border:2px solid #d1d5db;border-radius:10px;outline:none}
input.blk:focus{border-color:#2563eb;background:#f8fafc}
input.ok{border-color:var(--ok);background:#edf7ee}
input.ko{border-color:var(--ko);background:#fde8e8}
.feedback{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px}
.muted{color:#64748b;font-size:0.9rem}
#resetAll{background:none;border:none;color:#999;font-size:0.8rem;text-decoration:underline;cursor:pointer;margin-left:10px}
#resetAll:hover{color:#333}
</style>
</head>
<body>
<div class="bar">
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <a class="btn small" href="index.html" title="Accueil">üè† Accueil</a>
  </div>
  <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
    <button class="btn small" id="less" style="background:#fef3c7;border-color:#fcd34d">A‚àí</button>
    <button class="btn small" id="more" style="background:#dbeafe;border-color:#60a5fa">A+</button>
    <button class="btn primary" id="check">V√©rifier</button>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <h1>Prends des indices dans la phrase et compl√®te les terminaisons de ces verbes √† l‚Äôimp√©ratif</h1>

    <div id="exo">
      <p>1. Quand vous entrez, pens... <input class="blk" data-id="1" data-answer="ez"> √† retirer vos bottes.</p>
      <p>2. Il ne pleut plus. Pren... <input class="blk" data-id="2" data-answer="ons"> nos v√©los et part... <input class="blk" data-id="3" data-answer="ons"> en balade.</p>
      <p>3. Di... <input class="blk" data-id="4" data-answer="s"> √† tes parents que je voudrais leur parler et d√©p√™ch... <input class="blk" data-id="5" data-answer="e"> -toi !</p>
      <p>4. Di... <input class="blk" data-id="6" data-answer="sez"> √† votre fils de se taire imm√©diatement.</p>
      <p>5. Par... <input class="blk" data-id="7" data-answer="s"> vite et ne rentr... <input class="blk" data-id="8" data-answer="e"> pas trop tard pour te coucher t√¥t.</p>
    </div>

    <div class="feedback">
      <strong id="scoreline">Score : ‚Äì</strong>
      <span id="attemptline" class="muted">Tentatives : 0</span>
      <button class="btn small" id="resetColors">R√©essayer</button>
      <button id="resetAll" title="R√©initialiser tout">R√©initialiser le score cumul√©</button>
    </div>
  </div>
</div>

<script>
(()=>{
  const $=(s,ctx=document)=>ctx.querySelector(s);
  const $$=(s,ctx=document)=>Array.from(ctx.querySelectorAll(s));
  const inputs=$$('#exo input.blk');
  const btnCheck=$('#check');
  const scoreline=$('#scoreline');
  const attemptline=$('#attemptline');
  const btnReset=$('#resetColors');
  const btnResetAll=$('#resetAll');
  const btnMore=$('#more');
  const btnLess=$('#less');
  const LS_ATTEMPTS='ExI_termImperatif_attempts';
  const LS_FONT='ExI_termImperatif_font';

  const norm=s=>(s||'').toString().trim().toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ');

  const loadAttempts=()=>{try{return JSON.parse(localStorage.getItem(LS_ATTEMPTS)||'[]');}catch(_){return[];}};
  const saveAttempts=a=>localStorage.setItem(LS_ATTEMPTS,JSON.stringify(a));
  const resetAttempts=()=>localStorage.removeItem(LS_ATTEMPTS);

  function checkOnce(){
    let correct=0,total=inputs.length;
    const wrong=[];
    inputs.forEach(inp=>{
      const ok=norm(inp.value)===norm(inp.dataset.answer);
      inp.classList.remove('ok','ko');
      inp.classList.add(ok?'ok':'ko');
      if(ok)correct++;else wrong.push({id:inp.dataset.id,entered:(inp.value||'').trim(),expected:inp.dataset.answer});
    });
    const score=Math.round(100*correct/total);
    const now=new Date();
    const attempt={ts:now.toISOString(),nice:now.toLocaleString(),score,correct,total,wrong};
    const all=loadAttempts();all.push(attempt);saveAttempts(all);

    scoreline.textContent=`Score : ${correct}/${total} (${score}%)`;
    attemptline.textContent=`Tentatives : ${all.length}`;
    teleRap(all);
  }

  // teleRap : rapport HTML t√©l√©charg√© automatiquement
  function teleRap(all){
    const rows=all.map((a,i)=>{
      const w=a.wrong.length?a.wrong.map(w=>`<li><strong>${w.id}</strong> : saisi ‚Äú${esc(w.entered)}‚Äù / attendu ‚Äú${esc(w.expected)}‚Äù</li>`).join(''):'<li>Aucune erreur.</li>';
      return `<section style="margin:10px 0 18px"><h3 style="margin:0 0 6px">Tentative ${i+1} ‚Äì ${a.nice} ‚Äî Score ${a.correct}/${a.total} (${a.score}%)</h3><ul>${w}</ul></section>`;
    }).join('\n');
    const html=`<!doctype html><html lang="fr"><head><meta charset="utf-8"><title>Rapport ‚Äì Terminaisons imp√©ratif</title>
    <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:24px;line-height:1.5}h1{font-size:20px}</style></head>
    <body><h1>Rapport des erreurs ‚Äì Terminaisons √† l‚Äôimp√©ratif</h1>
    <p>Seules les mauvaises r√©ponses sont list√©es. Chaque clic sur V√©rifier cr√©e une nouvelle tentative.</p>${rows}</body></html>`;
    const who=(prompt("Pr√©nom de l‚Äô√©l√®ve (facultatif) :","")||"").trim();
    const fname=who?sanitize(who)+"-TerminaisonsImperatif.html":"C2Exo3.html";
    download(fname,html,"text/html;charset=utf-8");
  }

  function esc(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
  function sanitize(s){return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^A-Za-z0-9_-]+/g,'_');}
  function download(name,content,mime){
    const blob=new Blob([content],{type:mime});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download=name;document.body.appendChild(a);a.click();
    setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0);
  }

  // reset couleur
  btnReset.addEventListener('click',()=>inputs.forEach(i=>i.classList.remove('ok','ko')));
  // reset total
  btnResetAll.addEventListener('click',()=>{if(confirm("R√©initialiser toutes les tentatives ?")){resetAttempts();alert("Score cumul√© r√©initialis√©.");attemptline.textContent="Tentatives : 0";scoreline.textContent="Score : ‚Äì";}});

  // police A+A-
  function setFont(px){document.documentElement.style.setProperty('--base-size',px+'px');localStorage.setItem(LS_FONT,String(px));}
  btnMore.addEventListener('click',()=>{const cur=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--base-size'));setFont(Math.min(cur+2,28));});
  btnLess.addEventListener('click',()=>{const cur=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--base-size'));setFont(Math.max(cur-2,12));});
  const saved=parseInt(localStorage.getItem(LS_FONT)||'0');if(saved)setFont(saved);

  btnCheck.addEventListener('click',checkOnce);
})();
</script>
</body>
</html>
